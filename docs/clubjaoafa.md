# clubjaoafa

jao Minecraft Server Webサイト外部サービス。  
ログインシステムを構築しユーザー毎にサービスを提供するメンバーズポータルサイト。

登録はVerified権限以上の利用者のみ。登録後Defaultに降格した場合ログイン不能になる。

## 目標

従来Discord上で会話を行うことで処理されていた物事の大半をWebサイト上を通じてユーザー毎の表記ブレやシステムで抑えられるようなミスを防ぐことで作業を滞りなく行えるようにする。

## URL

- `https://club.jaoafa.com`

## ユーザーの流れ

### 初めて使うとき

1. Minecraft鯖内で`/getuserkey`を実行し、ユーザーを特定する認証コード(以下、`ユーザーキー`)を発行する。
2. clubjaoafaにアクセスし、`ユーザーキー`と`ユーザーパスワード`を入力の上新規登録する。ユーザーパスワードは個人で決める。

### 2回目から

1. clubjaoafaにアクセスし、`MinecraftID`(またはUUID)、`ユーザーパスワード`でログインする。

### パスワードが分からなくなったとき・パスワードを変更するとき

1. Minecraft鯖内で`/getuserkey`を実行し、ユーザーを特定する認証コード(以下、`ユーザーキー`)を発行する。
2. clubjaoafaにアクセスし、`ユーザーキー`を入力しアカウント存在確認。そのあと`ユーザーパスワード変更画面`に遷移

### MinecraftID変更時

- 基本的にユーザーによるなんらかの処理は必要なし。
- ログイン情報からUUIDを取得するため、jao Minecraft ServerにそのMinecraftIDの時にログインしていればどのMinecraftIDでもログイン可能

### 各申請時

1. clubjaoafaにアクセス、ログインする。
2. 該当する申請を選ぶ。
3. 必要に応じて該当する自治体名を選択し、必要事項を入力する。
4. 送信する。
5. サーバ側で送信内容の確認を行った後、運営内審議に上げる
6. 運営内審議終了後、データベースに反映する。
7. Discordにて#supportチャンネルを使いclubjaoafaBotからメッセージを送る
8. 必要に応じて手動で運営がWorldGuardなどの範囲変更処理を行う。

## 機能

- ダッシュボード (ユーザー情報とか情報+αを表示できるような…)
- 自治体申請関連全般。
  - 新規登録申請
  - 範囲変更申請
  - 名称変更申請
  - 情報変更申請
  - 自治体登録解除
- 運営向け
  - 証拠画像アップローダー

etc.  
出来ればヒラタケ以外も追加実装することのできるようなテンプレートとかがあったらうれしいかな～と思うがまあそれは必要に応じて。

## ユーザーキー仕様

- いわゆる「ワンタイムパスワード」
- 一度使ったらそれっきり。
- 1日を有効期限とする
- 10桁、アルファベット大文字小文字 (`[a-zA-Z]{10}`)
- `/getuserkey`はjaoafa/MyMaid3にて実装済み。 [実装コード](https://github.com/jaoafa/MyMaid3/blob/master/src/main/java/com/jaoafa/MyMaid3/Command/Cmd_GetUserKey.java#L69)

## バックグラウンド

- DB clubjaoafa - id, uuid, token, clubgroup, expire_at, created_at, updated_at
- **group**: clubjaoafaにおける権限グループ。通常ユーザーはDVR限らずdefault, 運営は管理部・モデレータ問わずadmin
- adminは自分が管理権限のない自治体の情報を変更することが可能。forceオプションで審議に通さずにそのままデータベースに反映可能
- APIは`api.jaoafa.com/v1/club`以下でホスト
- ログイン管理は次の通り
  - ログイン時にAPIがトークンを発行する。
  - JavaScript側でトークンを保持する。
  - すべての通信にそのトークンを付与する。
  - APIはトークンがデータベース記録の最新トークンと合致するかを調べた上で処理を行う。
  - トークンは**3時間を有効期限**とし、有効期限を超えた場合は再ログインを要求する。
- 各APIの動作処理(ログインを除く)はDiscordのロガーでロギングする。
